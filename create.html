<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â• åˆ›å»ºåº”ç”¨ - Mini-Application</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="back-link">â† è¿”å›</a>
            <h1>â• åˆ›å»ºå¾®åº”ç”¨</h1>
        </div>
        <nav class="header-nav">
            <a href="index.html" class="nav-link">ğŸ  é¦–é¡µ</a>
            <a href="profile.html" class="nav-link" id="profileLink">ğŸ‘¤ ä¸ªäºº</a>
            <a href="login.html" class="nav-link" id="loginLink">ğŸ‘¤ ç™»å½•</a>
        </nav>
    </header>

    <main class="main">
        <form class="create-form" id="createForm">
            <div class="form-group">
                <label for="appName">åº”ç”¨åç§° *</label>
                <input type="text" id="appName" required placeholder="è¾“å…¥åº”ç”¨åç§°" maxlength="50">
            </div>

            <div class="form-group">
                <label for="appDesc">åº”ç”¨æè¿° *</label>
                <textarea id="appDesc" required placeholder="ä¸€å¥è¯æè¿°è¿™ä¸ªåº”ç”¨çš„åŠŸèƒ½" maxlength="200" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="appType">åº”ç”¨ç±»å‹ *</label>
                <select id="appType" required>
                    <option value="tool">ğŸ› ï¸ å·¥å…·</option>
                    <option value="game">ğŸ® æ¸¸æˆ</option>
                    <option value="utility">ğŸ“ æ•ˆç‡</option>
                    <option value="other">ğŸ“¦ å…¶ä»–</option>
                </select>
            </div>

            <div class="form-group">
                <label for="appTags">åº”ç”¨æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="appTags" placeholder="å¦‚ï¼šå·¥å…·, å®ç”¨, æ—¥å¸¸">
                <p class="hint">è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¸®åŠ©ä»–äººå‘ç°ä½ çš„åº”ç”¨</p>
            </div>

            <div class="form-group">
                <label for="appCode">åº”ç”¨ä»£ç /é…ç½®</label>
                <textarea id="appCode" placeholder="è¾“å…¥åº”ç”¨çš„ HTML/CSS/JS ä»£ç ï¼Œæˆ–é…ç½®ä¿¡æ¯" rows="10" class="code-area"></textarea>
                <p class="hint">æ”¯æŒ HTML ä»£ç ï¼Œå°†ç›´æ¥åœ¨åº”ç”¨é¡µé¢ä¸­æ¸²æŸ“</p>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="location.href='index.html'">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜åº”ç”¨</button>
            </div>
        </form>
    </main>

    <script src="app.js"></script>
    <script>
        let editingId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const user = userStorage.getCurrentUser();
            if (!user) {
                alert('è¯·å…ˆç™»å½•åå†å‘å¸ƒåº”ç”¨');
                window.location.href = 'login.html';
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
            const urlParams = new URLSearchParams(window.location.search);
            editingId = urlParams.get('id');

            if (editingId) {
                document.querySelector('h1').textContent = 'âœï¸ ç¼–è¾‘åº”ç”¨';
                await loadAppData(editingId);
            }

            document.getElementById('createForm').addEventListener('submit', handleSubmit);
            
            // æ·»åŠ ä½œè€…ä¿¡æ¯åˆ°æäº¤æ•°æ®
            window.currentUser = user;
        });

        async function loadAppData(id) {
            const apps = await loadApps();
            const app = apps.applications.find(a => a.id === id);
            if (app) {
                document.getElementById('appName').value = app.name;
                document.getElementById('appDesc').value = app.description;
                document.getElementById('appType').value = app.type;
                document.getElementById('appCode').value = app.code || '';
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            // æ£€æŸ¥ç™»å½•
            const user = userStorage.getCurrentUser();
            if (!user) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'login.html';
                return;
            }

            const tagsInput = document.getElementById('appTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            const appData = {
                id: editingId || generateId(),
                name: document.getElementById('appName').value.trim(),
                description: document.getElementById('appDesc').value.trim(),
                type: document.getElementById('appType').value,
                tags: tags,
                code: document.getElementById('appCode').value.trim(),
                authorId: user.id,
                authorName: user.username,
                createdAt: editingId ? null : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (editingId) {
                appStorage.update(editingId, appData);
            } else {
                appStorage.add(appData);
            }

            alert('âœ… åº”ç”¨å·²ä¿å­˜ï¼');
            window.location.href = 'index.html';
        }

                document.getElementById('appCode').value = app.code || '';
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
    </script>
</body>
</html>
