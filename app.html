<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">åº”ç”¨åŠ è½½ä¸­... - Mini-Application</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .app-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .app-content { background: #fff; border-radius: 12px; padding: 30px; min-height: 400px; color: #333; }
        .app-back { display: inline-flex; align-items: center; gap: 8px; color: #667eea; text-decoration: none; margin-bottom: 20px; font-size: 14px; }
        .app-iframe { width: 100%; min-height: 500px; border: none; background: #fff; }
        .app-actions-bar { display: flex; gap: 15px; margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; flex-wrap: wrap; }
        .action-btn { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95em; transition: all 0.3s; }
        .action-btn.like { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .action-btn.like.active { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: #fff; }
        .action-btn.favorite { background: rgba(253,203,110,0.2); color: #fdcb6e; }
        .action-btn.favorite.active { background: linear-gradient(135deg, #fdcb6e, #e17055); color: #fff; }
        .action-btn.share { background: rgba(102,126,234,0.2); color: #667eea; }
        .action-btn:hover { transform: translateY(-2px); }
        .app-stats { display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.9em; opacity: 0.7; }
        .app-author { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .app-author-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .app-author-name { font-weight: 600; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <h1 id="appName">åŠ è½½ä¸­...</h1>
        </div>
        <a href="create.html" class="btn btn-secondary" id="editBtn">âœï¸ ç¼–è¾‘</a>
    </header>

    <main class="main">
        <div class="app-container">
            <p id="appDesc" class="app-description"></p>
            
            <div class="app-author" id="appAuthor" style="display: none;">
                <img class="app-author-avatar" id="authorAvatar" src="" alt="ä½œè€…å¤´åƒ">
                <div>
                    <div class="app-author-name" id="authorName"></div>
                    <div style="font-size: 0.85em; opacity: 0.7;" id="authorDate"></div>
                </div>
            </div>

            <div class="app-stats">
                <span id="viewsCount">ğŸ‘ï¸ 0</span>
                <span id="likesCount">â¤ï¸ 0</span>
                <span id="favoritesCount">â­ 0</span>
            </div>

            <div class="app-actions-bar">
                <button class="action-btn like" id="likeBtn" onclick="toggleLike()">
                    â¤ï¸ ç‚¹èµ <span id="likeNum">0</span>
                </button>
                <button class="action-btn favorite" id="favoriteBtn" onclick="toggleFavorite()">
                    â­ æ”¶è— <span id="favoriteNum">0</span>
                </button>
                <button class="action-btn share" onclick="shareApp()">
                    ğŸ”— åˆ†äº«
                </button>
            </div>

            <div class="app-content" id="appContent">
                <iframe id="appFrame" class="app-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>ğŸš€ Mini-Application å¾®åº”ç”¨å¸‚åœº</p>
    </footer>

    <script src="app.js"></script>
    <script>
        let currentApp = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const appId = urlParams.get('id');

            if (!appId) {
                alert('ç¼ºå°‘åº”ç”¨ID');
                window.location.href = 'index.html';
                return;
            }

            currentUser = userStorage.getCurrentUser();
            await loadApp(appId);
        });

        async function loadApp(appId) {
            const app = appStorage.getById(appId);
            
            if (!app) {
                alert('åº”ç”¨ä¸å­˜åœ¨');
                window.location.href = 'index.html';
                return;
            }

            currentApp = app;

            // æ›´æ–°é¡µé¢
            document.title = `${app.name} - Mini-Application`;
            document.getElementById('appName').textContent = app.name;
            document.getElementById('appDesc').textContent = app.description;
            
            // ä½œè€…ä¿¡æ¯
            if (app.authorName) {
                document.getElementById('appAuthor').style.display = 'flex';
                document.getElementById('authorName').textContent = app.authorName;
                document.getElementById('authorDate').textContent = formatDate(app.createdAt);
                document.getElementById('authorAvatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${app.authorName}`;
            }

            // ç¼–è¾‘æŒ‰é’®ï¼ˆä»…ä½œè€…å¯è§ï¼‰
            if (currentUser && currentUser.id === app.authorId) {
                document.getElementById('editBtn').href = `create.html?id=${appId}`;
            } else {
                document.getElementById('editBtn').style.display = 'none';
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats(appId);

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkAuthState(appId);

            // è®°å½•æµè§ˆ
            if (currentUser) {
                interactionStorage.recordView(currentUser.id, appId);
            }

            // æ¸²æŸ“åº”ç”¨å†…å®¹
            if (app.code) {
                const blob = new Blob([`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>${getBaseStyles()}</style>
                    </head>
                    <body>${app.code}</body>
                    </html>
                `], { type: 'text/html' });
                document.getElementById('appFrame').src = URL.createObjectURL(blob);
            }
        }

        function updateStats(appId) {
            const views = interactionStorage.getViewsCount(appId) + (currentApp.views || 0);
            const likes = interactionStorage.getLikesCount(appId);
            const favorites = interactionStorage.getUserFavorites(currentUser?.id || '').length;
            
            document.getElementById('viewsCount').innerHTML = `ğŸ‘ï¸ ${views}`;
            document.getElementById('likesCount').innerHTML = `â¤ï¸ ${likes}`;
            document.getElementById('favoritesCount').innerHTML = `â­ ${favorites}`;
            document.getElementById('likeNum').textContent = likes;
            document.getElementById('favoriteNum').textContent = favorites;
        }

        function checkAuthState(appId) {
            if (!currentUser) {
                document.getElementById('likeBtn').onclick = () => alert('è¯·å…ˆç™»å½•åç‚¹èµ');
                document.getElementById('favoriteBtn').onclick = () => alert('è¯·å…ˆç™»å½•åæ”¶è—');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
            const isLiked = interactionStorage.getLikesCount(appId) > 0;
            if (isLiked) {
                document.getElementById('likeBtn').classList.add('active');
            }

            // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
            if (interactionStorage.isFavorited(currentUser.id, appId)) {
                document.getElementById('favoriteBtn').classList.add('active');
            }
        }

        function toggleLike() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•åç‚¹èµ');
                window.location.href = 'login.html';
                return;
            }

            const result = interactionStorage.toggleLike(currentApp.id);
            if (result.success) {
                const btn = document.getElementById('likeBtn');
                btn.classList.toggle('active', result.liked);
                document.getElementById('likeNum').textContent = result.count;
                document.getElementById('likesCount').innerHTML = `â¤ï¸ ${result.count}`;
            }
        }

        function toggleFavorite() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•åæ”¶è—');
                window.location.href = 'login.html';
                return;
            }

            const result = interactionStorage.toggleFavorite(currentUser.id, currentApp.id);
            if (result.success) {
                const btn = document.getElementById('favoriteBtn');
                btn.classList.toggle('active', result.favorited);
                document.getElementById('favoriteNum').textContent = result.favorited 
                    ? interactionStorage.getUserFavorites(currentUser.id).length 
                    : interactionStorage.getUserFavorites(currentUser.id).length;
            }
        }

        function shareApp() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: currentApp.name,
                    text: currentApp.description,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            }
        }

        function getBaseStyles() {
            return `
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; }
                button { cursor: pointer; }
                input, textarea { font-family: inherit; }
            `;
        }
    </script>
</body>
</html>
