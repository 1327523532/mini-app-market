<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ Mini-Application å¾®åº”ç”¨å¸‚åœº</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>ğŸš€ Mini-Application</h1>
            <p class="tagline">å¾®åº”ç”¨å¸‚åœº Â· å‘ç°å¥½å·¥å…· Â· åˆ†äº«å¥½ç»éªŒ</p>
        </div>
        <nav class="header-nav">
            <a href="index.html" class="nav-link active">ğŸ  åº”ç”¨</a>
            <a href="demands.html" class="nav-link">ğŸ’¬ éœ€æ±‚</a>
            <a href="articles.html" class="nav-link">ğŸ“š åˆ†äº«</a>
            <a href="stats.html" class="nav-link">ğŸ“Š ç»Ÿè®¡</a>
            <span id="authNav">
                <a href="login.html" class="nav-link">ğŸ‘¤ ç™»å½•</a>
            </span>
            <a href="create.html" class="btn btn-primary">â• å‘å¸ƒ</a>
        </nav>
    </header>

    <main class="main">
        <section class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢åº”ç”¨åç§°ã€æè¿°æˆ–æ ‡ç­¾...">
                <button class="btn btn-primary" onclick="handleSearch()">æœç´¢</button>
            </div>
            <div class="tags-cloud" id="tagsCloud"></div>
        </section>

        <section class="filters">
            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
            <button class="filter-btn" data-filter="tool">ğŸ› ï¸ å·¥å…·</button>
            <button class="filter-btn" data-filter="game">ğŸ® æ¸¸æˆ</button>
            <button class="filter-btn" data-filter="utility">ğŸ“ æ•ˆç‡</button>
            <button class="filter-btn" data-filter="other">ğŸ“¦ å…¶ä»–</button>
        </section>

        <section class="apps-grid" id="appsGrid">
            <p class="empty-state">ğŸ“­ æš‚æ— åº”ç”¨ï¼Œç‚¹å‡»ã€Œåˆ›å»ºåº”ç”¨ã€æ·»åŠ ç¬¬ä¸€ä¸ªå¾®åº”ç”¨ï¼</p>
        </section>
    </main>

    <footer class="footer">
        <p>ğŸš€ Mini-Application å¾®åº”ç”¨å¸‚åœº | è®©æ¯ä¸ªäººéƒ½èƒ½å¿«é€Ÿæ„å»ºåº”ç”¨</p>
    </footer>

    <script src="refactored-app.js"></script>
    <script>
        let currentFilter = 'all';
        let currentKeyword = '';

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            initAuthNav();
        });

        // åˆå§‹åŒ–å¯¼èˆªæ ç™»å½•çŠ¶æ€
        function initAuthNav() {
            const user = userStorage.getCurrentUser();
            const authNav = document.getElementById('authNav');
            
            if (user) {
                authNav.innerHTML = `
                    <a href="profile.html" class="nav-link">ğŸ‘¤ ${user.username}</a>
                `;
            }
        }

        async function initApp() {
            renderApps();
            renderTagsCloud();
            initFilters();
            initSearch();
        }

        async function renderApps() {
            const grid = document.getElementById('appsGrid');
            let apps = { applications: [] };
            
            try {
                const localData = appStorage.getAll();
                if (localData.applications.length > 0) {
                    apps = localData;
                } else {
                    const response = await fetch('apps.json');
                    if (response.ok) apps = await response.json();
                }
            } catch (e) {}

            let applications = apps.applications || [];
            
            if (currentKeyword) {
                const kw = currentKeyword.toLowerCase();
                applications = applications.filter(a => 
                    a.name.toLowerCase().includes(kw) ||
                    a.description.toLowerCase().includes(kw) ||
                    (a.tags && a.tags.some(t => t.toLowerCase().includes(kw)))
                );
            }

            if (currentFilter !== 'all') {
                applications = applications.filter(a => a.type === currentFilter);
            }

            if (applications.length === 0) {
                grid.innerHTML = currentKeyword || currentFilter !== 'all' 
                    ? '<p class="empty-state">ğŸ” æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åº”ç”¨</p>'
                    : '<p class="empty-state">ğŸ“­ æš‚æ— åº”ç”¨ï¼Œç‚¹å‡»ã€Œåˆ›å»ºåº”ç”¨ã€æ·»åŠ ç¬¬ä¸€ä¸ªå¾®åº”ç”¨ï¼</p>';
                return;
            }

            grid.innerHTML = applications.map(app => `
                <article class="app-card" data-type="${app.type}" data-id="${app.id}">
                    <div class="app-icon">${getAppIcon(app.type)}</div>
                    <h3 class="app-name">${escapeHtml(app.name)}</h3>
                    <p class="app-desc">${escapeHtml(app.description)}</p>
                    <div class="app-tags">
                        ${(app.tags || []).slice(0, 3).map(tag => `<span class="tag-small">${escapeHtml(tag)}</span>`).join('')}
                    </div>
                    <div class="app-meta">
                        <span class="app-type">${getTypeName(app.type)}</span>
                        <span class="app-views">ğŸ‘ï¸ ${app.views || 0}</span>
                        <span class="app-date">${formatDate(app.createdAt)}</span>
                    </div>
                    <div class="app-actions">
                        <button class="btn-small btn-open" onclick="openApp('${app.id}')">æ‰“å¼€</button>
                        <button class="btn-small btn-edit" onclick="editApp('${app.id}')">ç¼–è¾‘</button>
                        <button class="btn-small btn-delete" onclick="deleteApp('${app.id}')">åˆ é™¤</button>
                    </div>
                </article>
            `).join('');
        }

        async function renderTagsCloud() {
            const cloud = document.getElementById('tagsCloud');
            const apps = appStorage.getAll();
            const tagCount = {};
            
            apps.applications.forEach(app => {
                (app.tags || []).forEach(tag => {
                    tagCount[tag] = (tagCount[tag] || 0) + 1;
                });
            });

            const tags = Object.entries(tagCount).sort((a, b) => b[1] - a[1]).slice(0, 10).map(([tag]) => tag);

            if (tags.length === 0) {
                cloud.innerHTML = '<p style="opacity:0.5;font-size:0.85em;">æš‚æ— æ ‡ç­¾</p>';
                return;
            }

            cloud.innerHTML = tags.map(tag => `<span class="tag" onclick="searchByTag('${tag}')">${tag}</span>`).join('');
        }

        function initSearch() {
            const input = document.getElementById('searchInput');
            let timeout;
            input.addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    currentKeyword = e.target.value.trim();
                    renderApps();
                }, 300);
            });
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
        }

        function handleSearch() {
            currentKeyword = document.getElementById('searchInput').value.trim();
            renderApps();
        }

        function searchByTag(tag) {
            currentKeyword = tag;
            document.getElementById('searchInput').value = tag;
            currentFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-filter="all"]').classList.add('active');
            renderApps();
        }

        function initFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderApps();
                });
            });
        }

        function openApp(id) {
            const app = appStorage.getById(id);
            if (app) appStorage.update(id, { views: (app.views || 0) + 1 });
            window.location.href = `app.html?id=${id}`;
        }

        function editApp(id) {
            window.location.href = `create.html?id=${id}`;
        }

        function deleteApp(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåº”ç”¨å—ï¼Ÿ')) return;
            appStorage.delete(id);
            renderApps();
            renderTagsCloud();
            alert('âœ… åº”ç”¨å·²åˆ é™¤');
        }
    </script>
</body>
</html>
